<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Websocket Testing</title>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  </head>
  <body>
    <div
      style="
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
        overflow: hidden;
        padding: 2rem;
        min-height: 100vh;
      "
    >
      <h1 id="group-name">Chat</h1>
      <h2>Change Name</h2>
      <input type="text" id="inpt2" />
      <button type="submit" onclick="changeName()">Change</button>
      <h2>Change Message</h2>
      <input type="text" id="inpt3" />
      <button type="submit" onclick="changeMessage()">Change</button>
      <h2>Change Member Role</h2>
      <input type="text" id="inpt4" />
      <button type="submit" onclick="editMember()">Change</button>
      <h2>New Message</h2>
      <input type="text" id="inpt1" />
      <button type="submit" onclick="sendMessage()">Send</button>
      <h1>Messages</h1>
      <div id="messages" style="display: flex; flex-direction: column"></div>
      <script async>
        function getTokenPayload(token) {
          let base64Url = token.split('.')[1];
          let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          let jsonPayload = decodeURIComponent(
            atob(base64)
              .split('')
              .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
              .join('')
          );
          return JSON.parse(jsonPayload);
        }
        const url = 'http://localhost:3000';
        const username = prompt('Enter username');
        const password = prompt('Enter password');
        let chatUuid;
        let socket;
        let chat;
        let token;
        const stuff = axios
          .post(`${url}/auth/login`, {
            username: username,
            password: password,
          })
          .catch((err) => alert('Invalid credentials'))
          .then(async ({ data }) => {
            token = data;
            chatUuid = prompt('Enter chat uuid');
            socket = io('http://localhost:3000', {
              transportOptions: { polling: { extraHeaders: { Authorization: `Bearer ${token}` } } },
            });
            const payload = getTokenPayload(token);
            console.log(payload, token);
            const user = await axios.get(`${url}/user/get/${payload.user}`, {
              headers: { Authorization: `Bearer ${token}` },
            });
            if (!user) alert('User Not Found');
            chatData = await axios.get(`${url}/chats/get/${chatUuid}`, {
              headers: { Authorization: `Bearer ${token}` },
            });
            chat = chatData.data;
            if (!chat) alert('Chat Not Found');
            /*  const sortedMessages = chat.messages.sort((a, b) => {
              const d1 = new Date(a.createdAt);
              const d2 = new Date(b.createdAt);
              return d1 > d2 ? 1 : -1;
            }); */

            chat.messages.forEach((message) => {
              createMessage(message.text, message.sender, message.createdAt, message.uuid);
            });

            document.getElementById('group-name').innerHTML = chat.name || 'Private Chat';
            socket.on('error', (err) => {
              console.log(err);
            });

            socket.on('disconnect', () => {});

            socket.on('MESSAGE', async ({ text, sender, createdAt, uuid, ...rest }) => {
              if (!rest || !chat) return;
              createMessage(text, sender, createdAt, uuid);
            });

            socket.on('CHAT_EDIT', ({ chat, name, ...rest }) => {
              document.getElementById('group-name').innerHTML = name;
            });

            socket.on('MESSAGE_EDIT', ({ message, text, pinned }) => {
              console.log('message edited');
              const children = document.getElementById('messages').children;
              for (let child of children) {
                if (child.dataset.uuid == message) child.childNodes[1].innerHTML = text;
              }
            });

            socket.on('MEMBER_EDIT', (member) => {
              console.log('Member Edited', member);
            });

            socket.on('chatDelete', ({ chat }) => {
              console.log('Chat Deleted', chat);
            });

            socket.on('MEMBER_JOIN', ({ chat, user }) => {
              console.log(`User Joined The Chat [${chat}]`, user);
            });

            socket.on('MEMBER_LEAVE', ({ chat, user }) => {
              console.log(`User Left The Chat [${chat}]`, user);
            });
          });
        function sendMessage() {
          const text = document.getElementById('inpt1').value;
          socket.emit('MESSAGE', {
            chat: chatUuid,
            data: text,
          });
          document.getElementById('inpt1').value = '';
        }

        function changeName() {
          const text = document.getElementById('inpt2').value;
          socket.emit('CHAT_EDIT', {
            chat: chatUuid,
            data: {
              name: text,
            },
          });
          document.getElementById('inpt2').value = '';
        }

        function changeMessage() {
          const message = 'c1f55f00-c10f-45d9-9ac0-a79e0bec1364';
          const text = document.getElementById('inpt3').value;
          socket.emit('MESSAGE_EDIT', {
            message: message,
            text: text,
          });
          document.getElementById('inpt3').value = '';
        }

        function editMember() {
          const member = '0ceeb8d2-b286-4e6d-b449-67348a5c02f4';
          const role = document.getElementById('inpt4').value;
          socket.emit('MEMBER_EDIT', {
            chat: chatUuid,
            data: {
              user: member,
              role: role,
            },
          });
          document.getElementById('inpt4').value = '';
        }

        const messages = document.getElementById('messages');
        async function createMessage(text, sender, createdAt, uuid) {
          const data = await axios.get(`${url}/user/get/${sender}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const user = data.data;
          const container = document.createElement('div');
          container.classList.add('message-container');
          container.dataset.uuid = uuid;
          const title = document.createElement('div');
          title.classList.add('message-title');
          const senderContainer = document.createElement('div');
          senderContainer.classList.add('sender-container');
          const senderName = document.createElement('div');
          const name = document.createTextNode(`${user.name}`);
          senderName.appendChild(name);
          senderName.classList.add('sender-name');
          const senderTag = document.createElement('div');
          const tag = document.createTextNode(`@${user.tag}`);
          senderTag.appendChild(tag);
          senderTag.classList.add('sender-tag');
          const date = document.createTextNode(new Date(createdAt).toLocaleString());
          senderContainer.appendChild(senderName);
          senderContainer.appendChild(senderTag);
          title.appendChild(senderContainer);
          title.appendChild(date);
          container.appendChild(title);
          const message = document.createElement('div');
          const content = document.createTextNode(`${text}`);
          message.appendChild(content);
          container.appendChild(message);
          messages.prepend(container);
        }
      </script>
      <style>
        body {
          padding: 0;
          margin: 0;
          font-size: 16px;
          color: #fff;
          background-color: rgb(113 162 234);
          overflow-x: hidden;
        }
        .message-container {
          background-color: #fff;
          color: rgb(21, 19, 19);
          display: flex;
          flex-direction: column;
          padding: 0.5rem;
          margin: 0.5rem;
          border-radius: 5px;
          box-shadow: 0 0 20px 2px rgb(0 0 0 / 30%);
        }
        .message-title {
          display: flex;
          flex-direction: row;
          padding-bottom: 0.5rem;
          justify-content: space-between;
        }
        .sender-container {
          display: flex;
          flex-direction: column;
        }
        .sender-name {
          font-weight: bold;
          font-size: 20px;
        }
        .sender-tag {
          color: rgb(58, 56, 56);
        }
      </style>
    </div>
  </body>
</html>
